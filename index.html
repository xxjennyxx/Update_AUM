<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teahouse Vaults AUM 全覽</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .container { max-width: 1100px; margin-top: 40px; }
        .vault-table th, .vault-table td { vertical-align: middle; }
        .symbol-price-input-block { margin-bottom: 1.5em; }
    </style>
</head>
<body>
<div class="container">
    <h2 class="mb-4">Teahouse Vaults AUM 全覽</h2>
    <div class="mb-3" id="dateInputBlock">
      <label for="dateInput" class="form-label">選擇日期</label>
      <input type="date" id="dateInput" class="form-control" style="max-width:200px;display:inline-block;">
      <div id="timestampInfo" style="margin-top:0.5em;color:#888;font-size:0.95em;display:none;"></div>
    </div>
    <div id="step1">
        <p>請先輸入所有 Easy Earn/Managed Vaults 會用到的主資產幣價：</p>
        <div id="symbol-price-inputs" class="symbol-price-input-block"></div>
        <button id="submit-prices" class="btn btn-primary">計算所有 Vaults AUM</button>
    </div>
    <div id="step2" style="display:none">
        <button id="backBtn" class="btn btn-outline-secondary mb-3">返回</button>
        <div id="vaults-table-block"></div>
    </div>
</div>
<script>
const VAULTS_JSON = 'vaults.json';
let vaults = [];
let priceMap = {};
let selectedTimestamp = null;
let selectedDate = null;
let lastVaultsData = null;

async function fetchVaultsJson() {
    const resp = await fetch(VAULTS_JSON);
    return await resp.json();
}

function getUniqueSymbols(vaults) {
    // 只抓 Easy Earn/Managed Vaults
    const set = new Set();
    vaults.forEach(v => {
        if (v.vaultCategory && (v.vaultCategory.toLowerCase() === 'easy earn' || v.vaultCategory.toLowerCase() === 'managed vaults')) {
            set.add(v.symbol);
        }
    });
    return Array.from(set);
}

function parseAUMReadable(aumStr) {
    // "1,234.56 WBTC" -> 1234.56
    if (!aumStr) return 0;
    try {
        if (typeof aumStr === 'string') {
            const main = aumStr.split(' ')[0].replace(/,/g, '');
            return parseFloat(main);
        }
    } catch {}
    return 0;
}

function renderSymbolPriceInputs(symbols) {
    // 處理 WBTC 與 BTCB 綁定輸入
    return symbols.map(sym => {
        let defaultVal = '';
        if (sym === 'USDC' || sym === 'USDT' || sym === 'USDC.e') defaultVal = '1';
        // 標記 WBTC 與 BTCB 欄位
        let extraAttr = '';
        if (sym === 'WBTC') extraAttr = 'id="price-wbtc"';
        if (sym === 'BTCB') extraAttr = 'id="price-btcb"';
        return `
            <label class="form-label me-3">${sym} 幣價：
                <input type="number" step="any" min="0" class="form-control d-inline-block symbol-price-input" data-symbol="${sym}" style="width:120px;display:inline-block" required value="${defaultVal}" ${extraAttr}>
            </label>
        `;
    }).join(' ');
}

function normalizeUnit(unit) {
    // 將特殊單位轉換為網站顯示需求
    if (!unit) return '';
    if (unit === 'USDC.e' || unit === 'axlUSDC') return 'USDC';
    if (unit === 'WETH') return 'ETH';
    if (unit === 'WBTC') return 'BTC';
    return unit;
}

function formatNumberShort(num) {
    // 將數字轉為 K/M 簡寫
    const n = Math.abs(num);
    if (n >= 1_000_000) return (num / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';
    if (n >= 1_000) return (num / 1_000).toFixed(n >= 10_000 ? 0 : 2).replace(/\.0+$/, '') + 'K';
    return num.toLocaleString();
}

function formatAUMWithUnit(aumStr) {
    // 處理 AUM 欄位的單位顯示規則，並加上 K/M 簡寫
    if (!aumStr) return '';
    const match = aumStr.match(/^([\d,\.]+)\s*([A-Za-z.]+)$/);
    if (match) {
        let num = match[1];
        const unit = normalizeUnit(match[2]);
        const raw = parseFloat(num.replace(/,/g, ''));
        // 處理 0.00 顯示 <0.01
        if (raw === 0) {
            return `<0.01 ${unit}`;
        }
        // K/M 簡寫
        return `${formatNumberShort(raw)} ${unit}`;
    }
    return aumStr;
}

function formatAUMUSD(aumStr) {
    // 處理 USD 結果顯示規則，e.g. "0.00 USD" → "<0.01 USD"，加上 K/M 簡寫
    if (!aumStr) return '';
    const match = aumStr.match(/^([\d,\.]+)\s*USD$/);
    if (match) {
        let num = match[1];
        const raw = parseFloat(num.replace(/,/g, ''));
        if (raw === 0) {
            return '<0.01 USD';
        }
        return `${formatNumberShort(raw)} USD`;
    }
    return aumStr;
}

function renderVaultsTable(vaults, priceMap) {
    // 依照 vault 類型排序：LP Vaults > Portfolio > Managed Vaults > Easy Earn
    const categoryOrder = {
        'lp vaults': 0,
        'portfolio': 1,
        'managed vaults': 2,
        'easy earn': 3
    };
    // 過濾掉 Easy Earn 單一鏈的資料，只保留非 Easy Earn 或 Easy Earn Total（AUM_SUMMARY）
    const easyEarnChains = new Set();
    const easyEarnSymbols = new Set();
    vaults.forEach(v => {
        if (v.vaultCategory && v.vaultCategory.toLowerCase() === 'easy earn') {
            if (v.chain) easyEarnChains.add(v.chain);
            if (v.symbol) easyEarnSymbols.add(v.symbol);
        }
    });
    // 只保留非 Easy Earn vault 或 Easy Earn Total (AUM_SUMMARY)
    const filteredVaults = vaults.filter(v => v.vaultCategory && v.vaultCategory.toLowerCase() !== 'easy earn');
    // 排序
    const sortedVaults = [...filteredVaults].sort((a, b) => {
        const ca = (a.vaultCategory || '').toLowerCase();
        const cb = (b.vaultCategory || '').toLowerCase();
        const oa = categoryOrder.hasOwnProperty(ca) ? categoryOrder[ca] : 99;
        const ob = categoryOrder.hasOwnProperty(cb) ? categoryOrder[cb] : 99;
        if (oa !== ob) return oa - ob;
        // 次排序：symbol
        return (a.symbol || '').localeCompare(b.symbol || '');
    });
    let rows = [];
    sortedVaults.forEach((vault, i) => {
        // 僅顯示 isActive 為 true 的 vault（AUM_SUMMARY 沒有 isActive 欄位）
        if (vault.isActive === false) return;
        let aumValue = '';
        let usdValue = '';
        const isEasyEarn = vault.vaultCategory && vault.vaultCategory.toLowerCase() === 'easy earn';
        const isSummary = vault.vaultCategory === 'AUM_SUMMARY' || vault.vaultCategory === 'Easy Earn Total';
        const isLP = vault.vaultCategory && vault.vaultCategory.toLowerCase() === 'lp vaults';
        const isPortfolio = vault.vaultCategory && vault.vaultCategory.toLowerCase() === 'portfolio';
        const isManaged = vault.vaultCategory && vault.vaultCategory.toLowerCase() === 'managed vaults';
        let vaultCategoryDisplay = vault.vaultCategory;
        if (isSummary) vaultCategoryDisplay = 'Easy Earn Total';
        if (vault.mainAssetAUMReadable && vault.mainAssetAUMReadable !== 'No valid fund' && vault.mainAssetAUMReadable !== '' && vault.mainAssetAUMReadable !== undefined) {
            if (isSummary) {
                // Easy Earn Total: 主資產數量欄為空，AUM 欄顯示計算結果並加上 USD 單位
                aumValue = '';
                const symbol = vault.symbol;
                const price = priceMap[symbol] || 0;
                let amt = 0;
                if (typeof vault.mainAssetAUMReadable === 'string') {
                    const main = vault.mainAssetAUMReadable.split(' ')[0].replace(/,/g, '');
                    amt = parseFloat(main);
                }
                let usd = price ? (amt * price).toLocaleString(undefined, {maximumFractionDigits: 2}) + ' USD' : '';
                usdValue = formatAUMUSD(usd);
            } else if (isEasyEarn) {
                /*
                aumValue = formatAUMWithUnit(vault.mainAssetAUMReadable);
                const symbol = vault.symbol;
                const price = priceMap[symbol] || 0;
                const amt = parseAUMReadable(vault.mainAssetAUMReadable);
                let usd = price ? (amt * price).toLocaleString(undefined, {maximumFractionDigits: 2}) + ' USD' : '';
                usdValue = formatAUMUSD(usd);
                */
            } else if (isManaged) {
                aumValue = formatAUMWithUnit(vault.mainAssetAUMReadable);
                let amt = parseAUMReadable(vault.mainAssetAUMReadable);
                let unit = '';
                if (typeof vault.mainAssetAUMReadable === 'string') {
                    const match = vault.mainAssetAUMReadable.match(/^([\d,\.]+)\s*([A-Za-z.]+)$/);
                    if (match) unit = normalizeUnit(match[2]);
                }
                usdValue = amt === 0 ? '<0.01 ' + unit : (amt >= 1_000_000 ? (amt / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M ' + unit : amt >= 1_000 ? (amt / 1_000).toFixed(2).replace(/\.0+$/, '') + 'K ' + unit : amt.toLocaleString(undefined, {maximumFractionDigits: 2}) + ' ' + unit);
            } else if (isLP || isPortfolio) {
                aumValue = formatAUMWithUnit(vault.mainAssetAUMReadable);
                usdValue = formatAUMWithUnit(vault.mainAssetAUMReadable);
            }
        } else {
            aumValue = vault.mainAssetAUMReadable || 'No valid fund';
        }
        // 新增 Easy Earn Total 的 chain 說明（優先用 chains 欄位，否則 fallback 舊寫法）
        let strategyExtra = '';
        let chainDisplay = vault.chain || '';
        if (isSummary) {
            let chains = vault.chains || [];
            if (chains.length === 0 && easyEarnChains.size > 0) {
                chains = Array.from(easyEarnChains);
            }
            if (chains.length > 0) {
                chainDisplay = chains.map(c => c.slice(1)).join(', ');
            }
        }
        rows.push(`
            <tr>
                <td>${vaultCategoryDisplay}</td>
                <td>${vault.Strategy}${strategyExtra}</td>
                <td>${chainDisplay}</td>
                <td>${vault.protocol}</td>
                <td>${vault.symbol}</td>
                <td>${formatAUMWithUnit(aumValue)}</td>
                <td>${isSummary ? usdValue : (isLP || isPortfolio ? usdValue : (isManaged ? usdValue : 'N/A'))}</td>
            </tr>
        `);
    });
    return `
        <table class="table table-bordered vault-table">
            <thead class="table-light">
                <tr>
                    <th>Vault Category</th>
                    <th>Strategy</th>
                    <th>Chain</th>
                    <th>Protocol</th>
                    <th>Symbol</th>
                    <th>主資產數量</th>
                    <th>AUM</th>
                </tr>
            </thead>
            <tbody>${rows.join('')}</tbody>
        </table>
    `;
}

// 請填入你的 Cloudflare Worker Vaults API URL
const VAULTS_API_URL = 'https://aum.imjennyyang.workers.dev/';

function getUTCTimestampsForDate(dateStr) {
  // dateStr: yyyy-mm-dd
  if (!dateStr) return { start: '', end: '' };
  const d = new Date(dateStr + 'T00:00:00Z');
  const start = Math.floor(d.getTime() / 1000);
  const end = start + 86399; // 23:59:59 UTC
  return { start, end };
}

function fetchVaultsWithTimestamp(ts) {
  const url = `${VAULTS_API_URL}?timestamp=${ts}`;
  return fetch(url).then(res => res.json());
}

document.getElementById('dateInput').addEventListener('input', function() {
  document.getElementById('timestampInfo').style.display = 'none';
  const val = this.value;
  if (!val) return;
  selectedDate = val;
  const { end } = getUTCTimestampsForDate(val);
  selectedTimestamp = end;
});

document.getElementById('submit-prices').onclick = function() {
  // 檢查所有必填
  let valid = true;
  document.querySelectorAll('.symbol-price-input').forEach(input => {
    if (!input.value || isNaN(parseFloat(input.value))) valid = false;
  });
  if (!valid) {
    alert('請輸入所有主資產的幣價！');
    return;
  }
  // 讀取所有 symbol 幣價
  priceMap = {};
  document.querySelectorAll('.symbol-price-input').forEach(input => {
    priceMap[input.dataset.symbol] = parseFloat(input.value) || 0;
  });
  if (!selectedTimestamp) {
    alert('請先選擇日期');
    return;
  }
  fetchVaultsWithTimestamp(selectedTimestamp).then(data => {
    lastVaultsData = data;
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = '';
    document.getElementById('vaults-table-block').innerHTML = renderVaultsTable(data, priceMap);
    document.getElementById('dateInputBlock').style.display = 'none';
  });
};

document.getElementById('backBtn').onclick = function() {
  document.getElementById('step2').style.display = 'none';
  document.getElementById('step1').style.display = '';
  document.getElementById('dateInputBlock').style.display = '';
};

// 讓 WBTC 價格變動時預設填入 BTCB，但 BTCB 可手動修改
function setupWBTCBTCBLink() {
    const wbtcInput = document.getElementById('price-wbtc');
    const btcbInput = document.getElementById('price-btcb');
    if (wbtcInput && btcbInput) {
        // 只在 WBTC 輸入時自動帶入 BTCB
        wbtcInput.addEventListener('input', () => {
            // 僅當 BTCB 尚未被手動修改過或與 WBTC 相同時才同步
            if (!btcbInput._userModified || btcbInput.value === '' || btcbInput.value === wbtcInput.oldValue || btcbInput.value === wbtcInput.oldValue + '') {
                btcbInput.value = wbtcInput.value;
            }
            wbtcInput.oldValue = wbtcInput.value;
        });
        // 使用者手動修改 BTCB 時，標記 _userModified
        btcbInput.addEventListener('input', () => {
            btcbInput._userModified = true;
        });
    }
}

// 主流程
async function init() {
    vaults = await fetchVaultsJson();
    // 只抓 Easy Earn/Managed Vaults 的 symbol
    const symbols = getUniqueSymbols(vaults);
    document.getElementById('symbol-price-inputs').innerHTML = renderSymbolPriceInputs(symbols);
    setupWBTCBTCBLink();
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
