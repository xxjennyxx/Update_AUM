<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teahouse Vaults AUM 全覽</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .container { max-width: 1100px; margin-top: 40px; }
        .vault-table th, .vault-table td { vertical-align: middle; }
        .symbol-price-input-block { margin-bottom: 1.5em; }
    </style>
</head>
<body>
<div class="container">
    <h2 class="mb-4">Teahouse Vaults AUM 全覽</h2>
    <div id="step1">
        <p>請先輸入所有 Easy Earn/Managed Vaults 會用到的主資產幣價：</p>
        <div id="symbol-price-inputs" class="symbol-price-input-block"></div>
        <button id="submit-prices" class="btn btn-primary">計算所有 Vaults AUM</button>
    </div>
    <div id="step2" style="display:none">
        <h4 class="mb-3">所有 Vaults 詳細表格</h4>
        <div id="vaults-table-block"></div>
    </div>
</div>
<script>
const VAULTS_JSON = 'vaults.json';
let vaults = [];
let priceMap = {};

async function fetchVaultsJson() {
    const resp = await fetch(VAULTS_JSON);
    return await resp.json();
}

function getUniqueSymbols(vaults) {
    // 只抓 Easy Earn/Managed Vaults
    const set = new Set();
    vaults.forEach(v => {
        if (v.vaultCategory && (v.vaultCategory.toLowerCase() === 'easy earn' || v.vaultCategory.toLowerCase() === 'managed vaults')) {
            set.add(v.symbol);
        }
    });
    return Array.from(set);
}

function parseAUMReadable(aumStr) {
    // "1,234.56 WBTC" -> 1234.56
    if (!aumStr) return 0;
    try {
        if (typeof aumStr === 'string') {
            const main = aumStr.split(' ')[0].replace(/,/g, '');
            return parseFloat(main);
        }
    } catch {}
    return 0;
}

function renderSymbolPriceInputs(symbols) {
    // 處理 WBTC 與 BTCB 綁定輸入
    return symbols.map(sym => {
        let defaultVal = '';
        if (sym === 'USDC' || sym === 'USDT' || sym === 'USDC.e') defaultVal = '1';
        // 標記 WBTC 與 BTCB 欄位
        let extraAttr = '';
        if (sym === 'WBTC') extraAttr = 'id="price-wbtc"';
        if (sym === 'BTCB') extraAttr = 'id="price-btcb"';
        return `
            <label class="form-label me-3">${sym} 幣價：
                <input type="number" step="any" min="0" class="form-control d-inline-block symbol-price-input" data-symbol="${sym}" style="width:120px;display:inline-block" required value="${defaultVal}" ${extraAttr}>
            </label>
        `;
    }).join(' ');
}

function renderVaultsTable(vaults, priceMap) {
    let rows = [];
    vaults.forEach((vault, i) => {
        // 僅顯示 isActive 為 true 的 vault
        if (vault.isActive === false) return;
        let aumValue = '';
        let usdValue = '';
        const isEE = vault.vaultCategory && (vault.vaultCategory.toLowerCase() === 'easy earn' || vault.vaultCategory.toLowerCase() === 'managed vaults');
        const isSummary = vault.vaultCategory && vault.vaultCategory === 'AUM_SUMMARY';
        const isLP = vault.vaultCategory && vault.vaultCategory.toLowerCase() === 'lp vaults';
        const isPortfolio = vault.vaultCategory && vault.vaultCategory.toLowerCase() === 'portfolio';
        if (vault.mainAssetAUMReadable && vault.mainAssetAUMReadable !== 'No valid fund' && vault.mainAssetAUMReadable !== '' && vault.mainAssetAUMReadable !== undefined) {
            if (isSummary) {
                // AUM_SUMMARY: 主資產數量欄為空，AUM 欄顯示計算結果並加上 USD 單位
                aumValue = '';
                const symbol = vault.symbol;
                const price = priceMap[symbol] || 0;
                let amt = 0;
                if (typeof vault.mainAssetAUMReadable === 'string') {
                    const main = vault.mainAssetAUMReadable.split(' ')[0].replace(/,/g, '');
                    amt = parseFloat(main);
                }
                usdValue = price ? (amt * price).toLocaleString(undefined, {maximumFractionDigits: 2}) + ' USD' : '';
            } else {
                aumValue = vault.mainAssetAUMReadable;
                if (isEE) {
                    const symbol = vault.symbol;
                    const price = priceMap[symbol] || 0;
                    const amt = parseAUMReadable(vault.mainAssetAUMReadable);
                    usdValue = price ? (amt * price).toLocaleString(undefined, {maximumFractionDigits: 2}) + ' USD' : '';
                } else if (isLP || isPortfolio) {
                    usdValue = vault.mainAssetAUMReadable;
                }
            }
        } else {
            aumValue = vault.mainAssetAUMReadable || 'No valid fund';
        }
        rows.push(`
            <tr>
                <td>${vault.vaultCategory}</td>
                <td>${vault.Strategy}</td>
                <td>${vault.protocol}</td>
                <td>${vault.symbol}</td>
                <td>${aumValue}</td>
                <td>${isSummary ? usdValue : (isLP || isPortfolio ? usdValue : (isEE ? (usdValue ? usdValue : '') : 'N/A'))}</td>
            </tr>
        `);
    });
    return `
        <table class="table table-bordered vault-table">
            <thead class="table-light">
                <tr>
                    <th>Vault Category</th>
                    <th>Strategy</th>
                    <th>Protocol</th>
                    <th>Symbol</th>
                    <th>主資產數量</th>
                    <th>AUM</th>
                </tr>
            </thead>
            <tbody>${rows.join('')}</tbody>
        </table>
    `;
}

// 讓 WBTC 價格變動時預設填入 BTCB，但 BTCB 可手動修改
function setupWBTCBTCBLink() {
    const wbtcInput = document.getElementById('price-wbtc');
    const btcbInput = document.getElementById('price-btcb');
    if (wbtcInput && btcbInput) {
        // 只在 WBTC 輸入時自動帶入 BTCB
        wbtcInput.addEventListener('input', () => {
            // 僅當 BTCB 尚未被手動修改過或與 WBTC 相同時才同步
            if (!btcbInput._userModified || btcbInput.value === '' || btcbInput.value === wbtcInput.oldValue || btcbInput.value === wbtcInput.oldValue + '') {
                btcbInput.value = wbtcInput.value;
            }
            wbtcInput.oldValue = wbtcInput.value;
        });
        // 使用者手動修改 BTCB 時，標記 _userModified
        btcbInput.addEventListener('input', () => {
            btcbInput._userModified = true;
        });
    }
}

// 主流程
async function init() {
    vaults = await fetchVaultsJson();
    // 只抓 Easy Earn/Managed Vaults 的 symbol
    const symbols = getUniqueSymbols(vaults);
    document.getElementById('symbol-price-inputs').innerHTML = renderSymbolPriceInputs(symbols);
    setupWBTCBTCBLink();
    document.getElementById('submit-prices').onclick = function() {
        // 檢查所有必填
        let valid = true;
        document.querySelectorAll('.symbol-price-input').forEach(input => {
            if (!input.value || isNaN(parseFloat(input.value))) valid = false;
        });
        if (!valid) {
            alert('請輸入所有主資產的幣價！');
            return;
        }
        // 讀取所有 symbol 幣價
        document.querySelectorAll('.symbol-price-input').forEach(input => {
            priceMap[input.dataset.symbol] = parseFloat(input.value) || 0;
        });
        // 顯示 vaults 詳細表格
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = '';
        document.getElementById('vaults-table-block').innerHTML = renderVaultsTable(vaults, priceMap);
    }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
