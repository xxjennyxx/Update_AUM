<!--
Teahouse Vaults AUM Overview Page
- Allows users to select a date and query all vaults' AUM (Assets Under Management)
- User flow: select date → click confirm → loading → input prices → calculate → show all vaults results, can download as Excel
- All UI blocks and JS logic are annotated in detail below.
-->

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teahouse Vaults AUM 全覽</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .container { max-width: 1100px; margin-top: 40px; }
        .vault-table th, .vault-table td { vertical-align: middle; }
        .symbol-price-input-block { margin-bottom: 1.5em; }
    </style>
</head>
<body>
<div class="container">
    <h2 class="mb-4">Teahouse Vaults AUM 全覽</h2>
    <!-- 日期輸入區塊（使用者選擇查詢日期） -->
    <div class="mb-3" id="dateInputBlock">
      <!-- Date input section: user selects the date to query vaults AUM -->
      <label for="dateInput" class="form-label">選擇日期</label>
      <input type="date" id="dateInput" class="form-control" style="max-width:200px;display:inline-block;">
      <!-- User must click confirm to start fetching data -->
      <button id="confirm-date" class="btn btn-secondary ms-2">確認</button>
      <div id="timestampInfo" style="margin-top:0.5em;color:#888;font-size:0.95em;display:none;"></div>
    </div>
    <!-- Loading spinner: shown while fetching vaults data from API -->
    <div id="loading-block" style="display:none;text-align:center;margin:32px 0;">
      <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div style="margin-top:1em;color:#888;">資料抓取中，請稍候...</div>
    </div>
    <!-- Price input section (step1): shown after vaults data is fetched -->
    <div id="step1" style="display:none">
        <p>請先輸入所有 Easy Earn/Managed Vaults 會用到的主資產幣價：</p>
        <div id="symbol-price-inputs" class="symbol-price-input-block"></div>
        <button id="submit-prices" class="btn btn-primary">計算所有 Vaults AUM</button>
    </div>
    <!-- Vaults result display section (step2): shown after calculation -->
    <div id="step2" style="display:none">
        <button id="backBtn" class="btn btn-outline-secondary mb-3">返回</button>
        <button id="download-excel" class="btn btn-success mb-3">下載 Excel</button>
        <div id="vaults-table-block"></div>
    </div>
</div>
<script>
// ===================== Variable Declarations =====================
// VAULTS_API_URL: Cloudflare Worker API endpoint
const VAULTS_API_URL = 'https://aum.imjennyyang.workers.dev/';
let priceMap = {};             // Mapping from symbol to user-input price
let selectedTimestamp = null;  // The UTC timestamp selected by the user
let selectedDate = null;       // The date string selected by the user
let lastVaultsData = [];       // Cached vaults data fetched from API
let allSymbols = [];           // All main asset symbols for price input

// ===================== Page Initialization =====================
// On page load, only the date selection block is shown
window.addEventListener('DOMContentLoaded', function() {
  document.getElementById('step1').style.display = 'none';
  document.getElementById('step2').style.display = 'none';
  document.getElementById('dateInputBlock').style.display = '';
  document.getElementById('loading-block').style.display = 'none';
});

// ===================== Date Confirm Button =====================
// User must click "Confirm" to start fetching data and show loading spinner
// 1. Show loading
// 2. Fetch vaults
// 3. Show main asset price input section
// 4. Hide loading

document.getElementById('confirm-date').addEventListener('click', async function() {
  document.getElementById('timestampInfo').style.display = 'none';
  const val = document.getElementById('dateInput').value;
  if (!val) return;
  selectedDate = val;
  // Get UTC 00:00:00 timestamp for the selected date
  const { start } = getUTCTimestampsForDate(val);
  selectedTimestamp = start;
  // Show loading spinner
  document.getElementById('loading-block').style.display = '';
  document.getElementById('step1').style.display = 'none';
  document.getElementById('step2').style.display = 'none';
  // Fetch all vaults in batches, cache the result
  lastVaultsData = await fetchAllVaultsWithTimestamp(selectedTimestamp, 10);
  // Extract all main asset symbols for Easy Earn/Managed Vaults
  allSymbols = Array.from(new Set(
    (lastVaultsData || []).filter(v => v.vaultCategory && (v.vaultCategory === 'Easy Earn' || v.vaultCategory === 'Managed Vaults')).map(v => v.symbol)
  ));
  // Render price input fields for each symbol
  document.getElementById('symbol-price-inputs').innerHTML = renderSymbolPriceInputs(allSymbols);
  setupWBTCBTCBLink();
  // Hide loading and show price input section
  document.getElementById('loading-block').style.display = 'none';
  document.getElementById('step1').style.display = '';
  document.getElementById('step2').style.display = 'none';
});

// ===================== Price Input, Calculation, and Table Rendering =====================
// User enters prices for all main assets, then clicks to calculate and display vaults AUM table
// The calculation and rendering logic continues as per the original JS flow

// ===================== Excel Download Button =====================
// When clicked, exports the vaults table as an .xls file for user download
function exportTableToExcel(tableId, filename = '') {
  const downloadLink = document.createElement('a');
  const tableSelect = document.getElementById(tableId);
  let tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');
  filename = filename ? filename + '.xls' : 'vaults_aum.xls';
  downloadLink.href = 'data:application/vnd.ms-excel,' + tableHTML;
  downloadLink.download = filename;
  document.body.appendChild(downloadLink);
  downloadLink.click();
  document.body.removeChild(downloadLink);
}
document.getElementById('download-excel').onclick = function() {
  exportTableToExcel('vaults-table', `vaults_aum_${selectedDate || ''}`);
};

// ===================== WBTC/BTCB Price Linkage =====================
// If user enters a value for WBTC, BTCB will auto-fill with the same value unless the user manually edits BTCB
function setupWBTCBTCBLink() {
    const wbtcInput = document.getElementById('price-wbtc');
    const btcbInput = document.getElementById('price-btcb');
    if (wbtcInput && btcbInput) {
        wbtcInput.addEventListener('input', () => {
            if (!btcbInput._userModified || btcbInput.value === '' || btcbInput.value === wbtcInput.oldValue || btcbInput.value === wbtcInput.oldValue + '') {
                btcbInput.value = wbtcInput.value;
            }
            wbtcInput.oldValue = wbtcInput.value;
        });
        btcbInput.addEventListener('input', () => {
            btcbInput._userModified = true;
        });
    }
}

// ===================== AUM Formatting Utility =====================
// Parses a human-readable AUM string to a float value
function parseAUMReadable(aumStr) {
    if (!aumStr) return 0;
    try {
        if (typeof aumStr === 'string') {
            const main = aumStr.split(' ')[0].replace(/,/g, '');
            return parseFloat(main);
        }
    } catch {}
    return 0;
}

function normalizeUnit(unit) {
    if (!unit) return '';
    if (unit === 'USDC.e' || unit === 'axlUSDC') return 'USDC';
    if (unit === 'WETH') return 'ETH';
    if (unit === 'WBTC') return 'BTC';
    return unit;
}

function formatNumberShort(num) {
    const n = Math.abs(num);
    if (n >= 1_000_000) return (num / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';
    if (n >= 1_000) return (num / 1_000).toFixed(n >= 10_000 ? 0 : 2).replace(/\.0+$/, '') + 'K';
    return num.toLocaleString();
}

function formatAUMWithUnit(aumStr) {
    if (!aumStr) return '';
    const match = aumStr.match(/^([\d,\.]+)\s*([A-Za-z.]+)$/);
    if (match) {
        let num = match[1];
        const unit = normalizeUnit(match[2]);
        const raw = parseFloat(num.replace(/,/g, ''));
        if (raw === 0) {
            return `<0.01 ${unit}`;
        }
        return `${formatNumberShort(raw)} ${unit}`;
    }
    return aumStr;
}

function formatAUMUSD(aumStr) {
    if (!aumStr) return '';
    const match = aumStr.match(/^([\d,\.]+)\s*USD$/);
    if (match) {
        let num = match[1];
        const raw = parseFloat(num.replace(/,/g, ''));
        if (raw === 0) {
            return '<0.01 USD';
        }
        return `${formatNumberShort(raw)} USD`;
    }
    return aumStr;
}

// ===================== Vaults 表格渲染 =====================
// Renders the vaults data as an HTML table for display
function renderVaultsTable(vaults, priceMap) {
    const categoryOrder = {
        'lp vaults': 0,
        'portfolio': 1,
        'managed vaults': 2,
        'easy earn': 3
    };
    const easyEarnChains = new Set();
    const easyEarnSymbols = new Set();
    vaults.forEach(v => {
        if (v.vaultCategory && v.vaultCategory.toLowerCase() === 'easy earn') {
            if (v.chain) easyEarnChains.add(v.chain);
            if (v.symbol) easyEarnSymbols.add(v.symbol);
        }
    });
    const filteredVaults = vaults.filter(v => v.vaultCategory && v.vaultCategory.toLowerCase() !== 'easy earn');
    const sortedVaults = [...filteredVaults].sort((a, b) => {
        const ca = (a.vaultCategory || '').toLowerCase();
        const cb = (b.vaultCategory || '').toLowerCase();
        const oa = categoryOrder.hasOwnProperty(ca) ? categoryOrder[ca] : 99;
        const ob = categoryOrder.hasOwnProperty(cb) ? categoryOrder[cb] : 99;
        if (oa !== ob) return oa - ob;
        return (a.symbol || '').localeCompare(b.symbol || '');
    });
    let rows = [];
    sortedVaults.forEach((vault, i) => {
        if (vault.isActive === false) return;
        let aumValue = '';
        let usdValue = '';
        const isEasyEarn = vault.vaultCategory && vault.vaultCategory.toLowerCase() === 'easy earn';
        const isSummary = vault.vaultCategory === 'AUM_SUMMARY' || vault.vaultCategory === 'Easy Earn Total';
        const isLP = vault.vaultCategory && vault.vaultCategory.toLowerCase() === 'lp vaults';
        const isPortfolio = vault.vaultCategory && vault.vaultCategory.toLowerCase() === 'portfolio';
        const isManaged = vault.vaultCategory && vault.vaultCategory.toLowerCase() === 'managed vaults';
        let vaultCategoryDisplay = vault.vaultCategory;
        if (isSummary) vaultCategoryDisplay = 'Easy Earn Total';
        if (vault.mainAssetAUMReadable && vault.mainAssetAUMReadable !== 'No valid fund' && vault.mainAssetAUMReadable !== '' && vault.mainAssetAUMReadable !== undefined) {
            if (isSummary) {
                aumValue = '';
                const symbol = vault.symbol;
                const price = priceMap[symbol] || 0;
                let amt = 0;
                if (typeof vault.mainAssetAUMReadable === 'string') {
                    const main = vault.mainAssetAUMReadable.split(' ')[0].replace(/,/g, '');
                    amt = parseFloat(main);
                }
                let usd = price ? (amt * price).toLocaleString(undefined, {maximumFractionDigits: 2}) + ' USD' : '';
                usdValue = formatAUMUSD(usd);
            } else if (isEasyEarn) {
                aumValue = formatAUMWithUnit(vault.mainAssetAUMReadable);
                const symbol = vault.symbol;
                const price = priceMap[symbol] || 0;
                const amt = parseAUMReadable(vault.mainAssetAUMReadable);
                let usd = price ? (amt * price).toLocaleString(undefined, {maximumFractionDigits: 2}) + ' USD' : '';
                usdValue = formatAUMUSD(usd);
            } else if (isManaged) {
                aumValue = formatAUMWithUnit(vault.mainAssetAUMReadable);
                let amt = parseAUMReadable(vault.mainAssetAUMReadable);
                let unit = '';
                if (typeof vault.mainAssetAUMReadable === 'string') {
                    const match = vault.mainAssetAUMReadable.match(/^([\d,\.]+)\s*([A-Za-z.]+)$/);
                    if (match) unit = normalizeUnit(match[2]);
                }
                usdValue = amt === 0 ? '<0.01 ' + unit : (amt >= 1_000_000 ? (amt / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M ' + unit : amt >= 1_000 ? (amt / 1_000).toFixed(2).replace(/\.0+$/, '') + 'K ' + unit : amt.toLocaleString(undefined, {maximumFractionDigits: 2}) + ' ' + unit);
            } else if (isLP || isPortfolio) {
                aumValue = formatAUMWithUnit(vault.mainAssetAUMReadable);
                usdValue = formatAUMWithUnit(vault.mainAssetAUMReadable);
            }
        } else {
            aumValue = vault.mainAssetAUMReadable || 'No valid fund';
        }
        let strategyExtra = '';
        let chainDisplay = vault.chain || '';
        if (isSummary) {
            let chains = vault.chains || [];
            if (chains.length === 0 && easyEarnChains.size > 0) {
                chains = Array.from(easyEarnChains);
            }
            if (chains.length > 0) {
                chainDisplay = chains.map(c => c.slice(1)).join(', ');
            }
        }
        rows.push(`
            <tr>
                <td>${vaultCategoryDisplay}</td>
                <td>${vault.Strategy}${strategyExtra}</td>
                <td>${chainDisplay}</td>
                <td>${vault.protocol}</td>
                <td>${vault.symbol}</td>
                <td>${formatAUMWithUnit(aumValue)}</td>
                <td>${isSummary ? usdValue : (isLP || isPortfolio ? usdValue : (isManaged ? usdValue : 'N/A'))}</td>
            </tr>
        `);
    });
    return `
        <table id="vaults-table" class="table table-bordered vault-table">
            <thead class="table-light">
                <tr>
                    <th>Vault Category</th>
                    <th>Strategy</th>
                    <th>Chain</th>
                    <th>Protocol</th>
                    <th>Symbol</th>
                    <th>主資產數量</th>
                    <th>AUM</th>
                </tr>
            </thead>
            <tbody>${rows.join('')}</tbody>
        </table>
    `;
}

// ===================== 幣價輸入欄位渲染 =====================
// Renders input fields for each main asset symbol
function renderSymbolPriceInputs(symbols) {
  return symbols.map(sym => {
    let defaultVal = '';
    if (sym === 'USDC' || sym === 'USDT' || sym === 'USDC.e') defaultVal = '1';
    let extraAttr = '';
    if (sym === 'WBTC') extraAttr = 'id="price-wbtc"';
    if (sym === 'BTCB') extraAttr = 'id="price-btcb"';
    return `
      <label class="form-label me-3">${sym} 幣價：
        <input type="number" step="any" min="0" class="form-control d-inline-block symbol-price-input" data-symbol="${sym}" style="width:120px;display:inline-block" required value="${defaultVal}" ${extraAttr}>
      </label>
    `;
  }).join(' ');
}

// ===================== UTC Timestamp 處理 =====================
// Converts a date string (yyyy-mm-dd) to UTC 00:00:00 and 23:59:59 timestamps
function getUTCTimestampsForDate(dateStr) {
  if (!dateStr) return { start: '', end: '' };
  const d = new Date(dateStr + 'T00:00:00Z');
  const start = Math.floor(d.getTime() / 1000); // UTC 00:00:00
  const end = start + 86399; // UTC 23:59:59
  return { start, end };
}

// ===================== API 資料抓取 =====================
// Fetches all vaults data from the API in batches, returns a merged array
async function fetchAllVaultsWithTimestamp(ts, pageSize = 10, maxPages = 100) {
  let allVaults = [];
  let page = 1;
  let hasMore = true;
  while (hasMore && page <= maxPages) {
    const url = `${VAULTS_API_URL}?timestamp=${ts}&page=${page}&page_size=${pageSize}`;
    const data = await fetch(url).then(res => res.json());
    if (!Array.isArray(data) || data.length === 0) break;
    allVaults = allVaults.concat(data);
    if (data.length < pageSize) {
      hasMore = false;
    } else {
      page++;
      await new Promise(r => setTimeout(r, 200)); // Avoid API rate limit
    }
  }
  return allVaults;
}

// ===================== 按鈕事件處理 =====================
// Handles the price submission and back button logic
// After price input, calculates and displays the vaults table
// Back button returns to price input section

document.getElementById('submit-prices').onclick = function() {
  let valid = true;
  document.querySelectorAll('.symbol-price-input').forEach(input => {
    if (!input.value || isNaN(parseFloat(input.value))) valid = false;
  });
  if (!valid) {
    alert('請輸入所有幣價');
    return;
  }
  priceMap = {};
  document.querySelectorAll('.symbol-price-input').forEach(input => {
    const symbol = input.getAttribute('data-symbol');
    priceMap[symbol] = parseFloat(input.value);
  });
  // Show result table (step2) using lastVaultsData and user priceMap
  document.getElementById('step1').style.display = 'none';
  document.getElementById('step2').style.display = '';
  document.getElementById('vaults-table-block').innerHTML = renderVaultsTable(lastVaultsData, priceMap);
  document.getElementById('dateInputBlock').style.display = 'none';
};

document.getElementById('backBtn').onclick = function() {
  document.getElementById('step2').style.display = 'none';
  document.getElementById('step1').style.display = '';
  document.getElementById('dateInputBlock').style.display = '';
};
</script>
</body>
</html>
